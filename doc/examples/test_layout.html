<!DOCTYPE html>
<html>
<head>
  <title>Test layout</title>

  <script type="text/javascript" src="js/firebug-fallback.js"></script>
  <!--
  <script type="text/javascript" src="https://getfirebug.com/firebug-lite.js">
    {
    overrideConsole: false,
    startInNewWindow: true,
    startOpened: true,
    enableTrace: true
    }
  </script>
  -->

  <link rel="stylesheet" type="text/css" media="screen" href="css/reset.css" /> 
  <style type="text/css">
    #content { 
      position: relative; 
      width: 400px;
      height: 400px;
      border: 1px solid black;
      z-index: 0;
    }
    .elem {
      position: absolute;
      border: 1px solid black;
      z-index: 1;
    }
   #control {
    float: right;
   }
    table, th, td
    {
    border: 1px solid black;
    }
    th { font-weight: bold; }

  </style>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="js/layout.js"></script>
  <script type="text/javascript">

function LayObj(w, h, bg) {
  this.active = true;
  this.isPlaced = false;
  this.w = w;
  this.h = h;
  this.bg = bg;
  this.getWidth = function() { return this.w; }
  this.getHeight = function() { return this.h; }
  this.div = $('<div/>').addClass("elem").hide().appendTo($("#content"));
		    
  this.place = function(X, Y, W, H) { 
    console.log("Getting placed: ", X, Y, W, H);
    console.log("bg: ", this.bg);
    this.div.css({"background-color": this.bg});
    if(!this.isPlaced)
	this.div.css({opacity: 0}).show();

    this.div.animate({ left: X, top: Y, width: W, height: H, opacity: 1.0});
    this.isPlaced = true;
  }
}

function updateActive(evObject) {
	var LO = evObject.data;
	var doFadeInOut = !!LO.active != !!evObject.target.checked;

	LO.active = evObject.target.checked;
	console.log("Update active ", LO.active);
	if (doFadeInOut) {
		if (!LO.active)
			LO.div.animate({opacity: 0});
/*		if (LO.active)
			LO.div.animate({opacity: 1});
		else
			LO.div.animate({opacity: 0});
*/
	}
        reLayout();
}
function updateWidth(evObject) {
	var LO = evObject.data;
	LO.w = parseInt(evObject.target.value);
	console.log("Update width ", LO.w);
        reLayout();
}
function updateHeight(evObject) {
	var LO = evObject.data;
	LO.h = parseInt(evObject.target.value);
	console.log("Update height ", LO.h);
        reLayout();
}
function updateBG(evObject) {
	var LO = evObject.data;
	LO.bg = evObject.target.value;
	console.log("Update bg ", LO.bg);
        reLayout();
}

function clickPlus(evObj) {
	var input = $(evObj.target).parent().parent().find('input');
	input.val(parseInt(input.val()) + 10)
	input.change();
}
function clickMinus(evObj) {
	var input = $(evObj.target).parent().parent().find('input');
	input.val(parseInt(input.val()) - 10)
	input.change();
}
function plusMinus(LO) {
	var buttonPlus = $('<button>+</button>').click(LO, clickPlus);
	var buttonMinus = $('<button>&minus;</button>').click(LO, clickMinus);
	return $('<div style="float:right"/>').append(buttonPlus, buttonMinus);
}

function addTableRow(layobjs) {
  var b = plusMinus;
  var tbody = $('#ctable > tbody:last');
  for (var i = 0; i < layobjs.length; i++) {
    var tr = tbody.append($('<tr>'));
    var LO = layobjs[i];
    // this is the kind of code that could - should - make you either love or hate jQuery. or both.
    tr.append($('<td>').append($('<input type="checkbox">').prop("checked", LO.active).change(LO, updateActive)));
    tr.append($('<td>').append(b(LO), $('<input type="text">').val(LO.w).change(LO, updateWidth))); 
    tr.append($('<td>').append(b(LO), $('<input type="text">').val(LO.h).change(LO, updateHeight)));
    tr.append($('<td>').append($('<input type="text">').val(LO.bg).change(LO, updateBG)));		    
  }
}

function reLayout() {
  var objs = $.grep($.ME.objs, function(o) { return o.active; });

  layout($.ME.box, objs, {padding: $.ME.padding});
}

function randVal() { 
	return parseInt(Math.random() * 100 + 10);
}

$(function() {
  // some examples - not used currently
  var o1 = [[10, 10, "red"], [10, 10, "blue"]];
  var o2 = [[20, 10, "#f00"], [10, 10, "#0f0"], [10, 10, "#00f"]];
  var o3 = [[10, 10, "red"], [10, 10, "blue"], [500, 10, "#ff0"]];
  var greedyFail = [[80, 50, "red"], [70, 50, "blue"], [20, 50, "red"], [15, 50, "blue"], [15, 50, "blue"]];
  // The above example should place the red objects on one row and the blue on the other. But it doesn't.

  colors = ["aqua", "black", "blue", "fuchsia", "grey", "green", "lime", "maroon", "navy", "olive", "purple", "red", "silver", "teal", "white", "yellow"]

  var objs = []
  for (var i = 0; i < colors.length; i++) {
    var lo = new LayObj(randVal(), randVal(), colors[i]);
    lo.active = Math.random() < 0.4;
    objs.push(lo);
  }
  var box = {getWidth: function() { return $("#content").width(); }, getHeight: function() { return $("#content").height(); }};

  $.ME = {box: box, objs: objs, padding: 20};

  reLayout();

      addTableRow(objs);

	/* We could use jQuery's .data(key, value) to connect the
	 * model and the views, so to speak. */

});

</script>
</head>
<body>
<div id="control">
(note: decimals are silently ignored)
<table id="ctable">
<tr><th>Active</th><th>Width</th><th>Height</th><th>Color</th></tr>
<tbody>
</tbody>
</table>
</div>
<div id="content"></div>
</body>
</html>
